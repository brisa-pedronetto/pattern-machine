<!--
I don't know much about licenses but I just wanted to
say you can take this, improve it and do whatever
you want with it. And if you want to reach out, here
it is: pedro@brisa.is 👍👍👍

Credits:
Pedro Netto / Author / pedro@brisa.is
Mike Ivanchyshyn / Rotation and Satisfaction ideation / imvasyl.com
Chee Basbas / Soundscape consulting
-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Pattern Machine by Pedro Netto (pedro@brisa.is)</title>

    <!-- Thanks Google -->
    <link href="https://fonts.googleapis.com/css2?family=Major+Mono+Display&family=Shadows+Into+Light&family=Syne+Mono&family=VT323&display=swap" rel="stylesheet">

    <!-- Thanks Webmaker -->
    <style id="webmakerstyle">
      body {
        background-color: #0a0a0a;
        overflow: hidden;
        font-family: sans-serif;
        font-size: 0.9rem;
        transition: background-color 0.5s ease;
      }

      a {
        color: white !important;
      }

      button {
        cursor: pointer;
      }

      #container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        font-family: monospace;
        line-break: anywhere;
        /* text-shadow: 3px 3px 15px black; Future? */
        transition: color 0.5s ease, background-color 0.5s ease;
        transform: rotate(45deg) scale(2);
        cursor: pointer;
        perspective: 500px;

        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      #container.satisfy > span.right {
        animation: satisfy 15s infinite linear;
      }

      #container.satisfy > span.left {
        animation: satisfy 15s reverse infinite linear;
      }

      @keyframes satisfy {
        0% {
          transform: scale(0.75) rotate(0deg);
        }
        50% {
          transform: scale(1.1) rotate(180deg);
        }
        100% {
          transform: scale(0.75) rotate(360deg);
        }
      }

      #controls {
        position: fixed;
        bottom: 0.5rem;
        right: 0.5rem;
        background: rgba(0, 0, 0, 0.7);
        padding: 1rem;
        border-radius: 4px;
        color: white;
      }

      #controls .title {
        font-family: 'VT323';
        font-size: 1.5rem;
      }

      #controls > button {
        display: block;
        margin-left: auto;
      }

      #controls.hide {
        padding: 0;
      }

      #controls.hide > button {
        transform: rotate(180deg);
      }

      #controls.hide > div {
        display: none;
      }

      #controls input:not([type="checkbox"]),
      #controls select,
      #controls div {
        display: block;
        margin-bottom: 0.75rem;
      }
    </style>
  </head>

  <body>
    <div id="container"></div>

    <div id="controls">
      <button id="toggle-controls">👇</button>

      <div>
        <h1 class="title">pattern machine</h1>

        <div>
          <input id="spicy" type="checkbox" /> <label for="spicy">Spicy</label>
        </div>
        <div>
          <input id="satisfy" type="checkbox" /> <label for="satisfy">Satisfy me</label>
        </div>
        <select id="font-family">
          <option value="Shadows Into Light">Shadows Into Light</option>
          <option value="Major Mono Display">Major Mono Display</option>
          <option value="Syne Mono">Syne Mono</option>
          <option value="VT323">VT323</option>
        </select>
        <label>FS</label> <input id="font-size" type="range" min="30" max="100" />
        <label>LS</label><input id="letter-spacing" type="range" min="10" max="100" /> <!-- Will be divided by 10 -->
        <label>LN</label><input id="line-height" type="range" min="10" max="15" /> <!-- Will be divided by 10 -->
        <label>RT</label><input id="rotation" type="range" min="0" max="365" step="10" />
        <div>
          <input id="bg-color" type="color"/>
          <input id="font-color" type="color"/>
        </div>
        <input id="pattern" />
        <div>
          <button id="go-back">Previous</button>
          <button id="go-forward">Next</button>
          <button id="randomize">Shazam!</button>
        </div>

        <audio id="audio" src="./atmospheric_sounds.mp3" />

        <div>
          <a href="https://github.com/brisa-pedronetto/pattern-machine" target="_blank">Github</a>
          <a href="https://codepen.io/brisa-pedronetto/pen/zYoJpWg" target="_blank">Codepen</a>
        </div>
      </div>
    </div>

    <script>
      const container = document.querySelector('#container');
      const patternInput = document.querySelector('#pattern');
      const fontSizeInput = document.querySelector('#font-size');
      const fontColorInput = document.querySelector('#font-color');
      const bgColorInput = document.querySelector('#bg-color');
      const rotationInput = document.querySelector('#rotation');
      const lineHeightInput = document.querySelector('#line-height');
      const letterSpacingInput = document.querySelector('#letter-spacing');
      const fontFamilyInput = document.querySelector('#font-family');
      const spicyInput = document.querySelector('#spicy');
      const satisfyInput = document.querySelector('#satisfy');
      const randomizeBtn = document.querySelector('#randomize');
      const previousBtn = document.querySelector('#go-back');
      const nextBtn = document.querySelector('#go-forward');
      const toggleControlsBtn = document.querySelector('#toggle-controls');
      const audio = document.querySelector('#audio');

      // Default config
      let config = {
        linePattern: '_._.—.—.',
        fontSize: 30,
        color: '#ffd700',
        backgroundColor: '#0a0a0a',
        rotation: 45,
        lineHeight: 1,
        fontFamily: 'Shadows Into Light',
        letterSpacing: 4,
        spicy: true
      }

      let history = [];
      let currentHistory = 0;

      // Define listeners actions
      const listeners = [
        [patternInput, 'linePattern'],
        [fontSizeInput, 'fontSize'],
        [fontColorInput, 'color'],
        [bgColorInput, 'backgroundColor'],
        [rotationInput, 'rotation'],
        [lineHeightInput, 'lineHeight'],
        [letterSpacingInput, 'letterSpacing'],
        [fontFamilyInput, 'fontFamily'],
        [spicyInput, 'spicy'],
        [satisfyInput, 'satisfy']
      ];

      // Transform HSL color to HEX
      // From https://stackoverflow.com/a/44134328
      function hslToHex(h, s, l) {
        l /= 100;
        const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
          const k = (n + h / 30) % 12;
          const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
          return Math.round(255 * color).toString(16).padStart(2, '0');   // convert to Hex and prefix "0" if needed
        };
        return `#${f(0)}${f(8)}${f(4)}`;
      }


      // Push current pattern to history
      function pushToHistory() {
        history.push({...config})
        currentHistory = history.length - 1;
      }

      function goTo(historyIndex) {
        config = {...history[historyIndex]}
        draw();
      }

      function goBack() {
        currentHistory--;

        if (currentHistory < 0) {
          currentHistory = 0;
          return;
        }

        goTo(currentHistory);
      }

      function goForward() {
        currentHistory++;

        if (currentHistory > history.length - 1) {
          randomize();
          draw()
          return;
        }

        goTo(currentHistory);
      }

      // Update inputs
      function updateInputs() {
        for (listener of listeners) {
          const [inputEl, configKey] = listener;
          if (inputEl.type === 'checkbox') {
            inputEl.checked = config[configKey];
          } else {
            inputEl.value = config[configKey];
          }
        }
      }

      // Get a random number between a mininum and maximum value
      function getRandomInRange(min, max) {
        return Math.floor(Math.random() * (max - min)) + min;
      }

      // Get a random HSL value, with lightness tone control
      function getRandomColor(lightnessMode) {
        const lightness = lightnessMode === 'dark' ? getRandomInRange(5, 20) : getRandomInRange(50, 80);
        return hslToHex(getRandomInRange(0, 255), getRandomInRange(0, 100), lightness);
      }

      // // Get a random gradient
      // function getRandomGradient(lightnessMode) {
      //   const hue = getRandomInRange(0, 255);
      //   const saturation = getRandomInRange(0, 100);
      //   const color1 = hslToHex(hue, saturation, getRandomInRange(5, 15));
      //   const color2 = hslToHex(hue, saturation, getRandomInRange(25, 30));

      //   return `linear-gradient(30deg, ${color1}, ${color2}`;
      // }

      // Get a string with random patterns to compose a pattern
      function getRandomPattern() {
        const allowedChars = '_*+.:,;ö~^´`';
        const charsLength = allowedChars.length;
        return [...Array(getRandomInRange(2,4))].map(()=>allowedChars[getRandomInRange(0, charsLength - 1)]).join('') + ' ';
      }

      // Chagne the container contents
      function draw () {
        container.style.fontSize = config.fontSize + 'px';
        container.style.color = config.color;

        container.style.backgroundColor = config.backgroundColor;
        document.body.style.backgroundColor = config.backgroundColor;
        // container.style.backgroundImage = config.backgroundColor; // Use gradient in the future?

        container.style.transform = `rotate(${config.rotation}deg) scale(2.5)`;
        container.style.letterSpacing = config.letterSpacing + 'px';
        container.style.lineHeight = config.lineHeight / 10;
        container.style.fontFamily = config.fontFamily;

        container.innerHTML = '';
        if (config.spicy || config.satisfy) {
          const fullStr = config.linePattern.repeat(500);
          const chars = fullStr.split('')
          const content = chars.map(char => {
            const wrapperEl = document.createElement('span');
            wrapperEl.style.display = `inline-block`;

            // For more satisfaction, randomize the rotation direction
            wrapperEl.classList.add(['right', 'left'][getRandomInRange(0, 2)]);

            if (config.spicy) {
              // If spicy rotate it
              const spicyEl = document.createElement("span");
              spicyEl.style.display = `inline-block`;
              spicyEl.style.transform = `rotateZ(${[0, 45, 90, 135][getRandomInRange(0, 4)]}deg)`;
              spicyEl.innerHTML = char;
              wrapperEl.appendChild(spicyEl);
            } else {
              wrapperEl.innerHTML = char;
            }

            if (config.satisfy) {
              audio.play();
            } else {
              audio.pause();
            }

            container.appendChild(wrapperEl);
          })
        } else {
          container.innerHTML = config.linePattern.repeat(500);
        }


        updateInputs();
      }

      // Randomize all parameters :)
      function randomize(options) {
        if (!options) options = {};

        const backgroundColor = getRandomColor('dark');
        // const backgroundColor = getRandomGradient();
        const color = getRandomColor('light');
        const fontSize = getRandomInRange(30, 100);
        const linePattern = getRandomPattern();
        const rotation = [0, 45, 90, 135][getRandomInRange(0, 5)];
        const lineHeight = getRandomInRange(10, 15);
        const letterSpacing = [30, 60][getRandomInRange(0, 2)];

        let fontFamily;
        if (options.skipFontRand) {
          fontFamily = config.fontFamily;
        } else {
          fontFamily = ['Major Mono Display',
                            'Shadows Into Light',
                            'Syne Mono',
                            'VT323'][getRandomInRange(0, 5)];
        }


        config = { ...config, backgroundColor, color, fontSize, linePattern, rotation, lineHeight, letterSpacing, fontFamily };

        updateInputs();
        pushToHistory();
      }

      // Initilize
      function init() {
        randomize();
        draw();

        function vai() {
          const options = {
            skipFontRand: true
          }
          randomize(options);
          draw();
        }

        // Initialize the app showcasing a few examples
        let count = 0;
        const presentationInt = setInterval(function() {
          count ++;
          vai();
          if (count > 10) clearInterval(presentationInt)
        }, 200);


        // Setup input listeners
        for (listener of listeners) {
          const [inputEl, configKey] = listener;

          // Draw whenever the user alters the input
          inputEl.addEventListener('input', function(e) {
            if (e.target.type === 'checkbox') {
              config[configKey] = inputEl.checked;
            } else {
              config[configKey] = inputEl.value;
            }
            draw();
          });

          // ONly push to history once the change is done
          inputEl.addEventListener('change', function(e) {
            pushToHistory();
          });
        }

        // Randomize button listener
        randomizeBtn.addEventListener('click', function(e) {
          randomize();
          draw();
        });

        // Make cLicking the container on mobile randomize
        container.addEventListener('click', function(e) {
          // Mobile only
          // if (window.innerWidth > 1024) return;

          randomize();
          draw();
        });

        // History button listeners
        previousBtn.addEventListener('click', function(e) {
          goBack();
        });
        nextBtn.addEventListener('click', function(e) {
          goForward();
        });

        // Controls visibility
        toggleControlsBtn.addEventListener('click', function(e) {
          e.target.parentNode.classList.toggle('hide');
        });

        // Satisfy input
        satisfyInput.addEventListener('click', function(e) {
          container.classList.toggle('satisfy');
        });
      }

      init();
    </script>
  </body>
</html>
